<script type="module">
	const default_config = {
		iceServers: [
			{ urls: 'stun:global.stun.twilio.com' },
			{ urls: 'stun:stun.l.google.com:19302' }
		]
	};
	class Conn extends RTCPeerConnection {
		#dc = this.createDataChannel('_', { negotiated: true, id: 0 })
		constructor(config = null) {
			super({ ...default_config, ...config });
			this.#dc.addEventListener('open', () => console.log('Connected!'));

			this.#signaling_task();
		}
		#local_res;
		#local = new Promise(res => this.#local_res = res);
		get local() {
			return this.#local;
		}
		#remote_res;
		#remote = new Promise(res => this.#remote_res = res);
		set remote(description) {
			this.#remote_res(description);
		}
		async #signaling_task() {
			await this.setLocalDescription();
			while (this.iceGatheringState != 'complete') await new Promise(res => this.addEventListener('icegatheringstatechange', res, {once: true}));
			const local = this.#collapse(this.localDescription);
			this.#local_res(local);

			const remote_desc = await this.#remote;
			await this.setRemoteDescription(this.#expand(remote_desc, local.id));
		}
		#collapse({type, sdp}) {
			const {1: ice_ufrag} = /^a=ice-ufrag:(.+)/im.exec(sdp);
			const {1: ice_pwd} = /^a=ice-pwd:(.+)/im.exec(sdp);
			const {1: fingerprint} = /^a=fingerprint:sha-256 (.+)/im.exec(sdp);
			const candidates = Array.from(sdp.matchAll(/^a=candidate:(.+)/igm), ({ 1: candidate}) => candidate);
			const id = btoa(String.fromCharCode(...fingerprint.split(':').map(s => parseInt(s, 16))));

			return {ice_ufrag, ice_pwd, id, candidates};
		}
		#expand({ice_ufrag, ice_pwd, id, candidates}, local_id) {
			const hex_local = Array.from(atob(local_id), c => c.charCodeAt(0).toString(16).padStart(2, '0'));
			const hex_remote = Array.from(atob(id), c => c.charCodeAt(0).toString(16).padStart(2, '0'));
			const localnum = BigInt('0x' + hex_local.join(''));
			const remotenum = BigInt('0x' + hex_remote.join(''));
			const polite = localnum < remotenum;

			const fingerprint = hex_remote.join(':');
			const sdp = [
				'v=0',
				'o=- 2914999304198734631 2 IN IP4 127.0.0.1',
				's=-',
				't=0 0',
				'm=application 9 UDP/DTLS/SCTP webrtc-datachannel',
				'c=IN IP4 0.0.0.0',
				...candidates.map(c => 'a=candidate:' + c),
				`a=ice-ufrag:${ice_ufrag}`,
				`a=ice-pwd:${ice_pwd}`,
				`a=fingerprint:sha-256 ${fingerprint}`,
				`a=setup:${polite ? 'passive' : 'active'}`,
				'a=sctp-port:5000',
				'',
			].join('\n');
			return {type: 'answer', sdp};
		}
	}

	const a = new Conn();
	const b = new Conn();
	
	const [siga, sigb] = await Promise.all([a.local, b.local]);
	console.log(siga);
	console.log(sigb);
	a.remote = sigb;
	b.remote = siga;
</script>
