<script type="module">
const a = new RTCPeerConnection();

const dc = a.createDataChannel('');
dc.addEventListener('open', () => console.log('connected!'));

await a.setLocalDescription();
while (a.iceGatheringState != 'complete') await new Promise(res => a.addEventListener('icegatheringstatechange', res, {once: true}));
const siga = collapse(a.localDescription);
console.log(siga);

const b = new RTCPeerConnection();
await b.setRemoteDescription(expand(siga));
await b.setLocalDescription();
while (b.iceGatheringState != 'complete') await new Promise(res => b.addEventListener('icegatheringstatechange', res, {once: true}));
const sigb = collapse(b.localDescription);
console.log(sigb);

await a.setRemoteDescription(expand(sigb));


function collapse({sdp, type}) {
	const { 1: ice_ufrag } = /a=ice-ufrag:(.+)/i.exec(sdp);
	const { 1: ice_pwd } = /a=ice-pwd:(.+)/i.exec(sdp);
	const { 1: fingerprint } = /a=fingerprint:sha-256 (.+)/i.exec(sdp);
	const id = btoa(String.fromCharCode(...fingerprint.split(':').map(s => parseInt(s, 16))));
	const candidates = Array.from(sdp.matchAll(/a=candidate:(.+)/ig), ({ 1: candidate }) => candidate);

	return {ice_ufrag, ice_pwd, id, candidates, type};
}
function expand({ice_ufrag, ice_pwd, id, candidates, type}) {
	const fingerprint = Array.from(atob(id), s => s.charCodeAt(0).toString(16).padStart(2, '0')).join(':');
	const sdp = [
		'v=0',
		'o=- 2438535120676279897 2 IN IP4 127.0.0.1',
		's=-',
		't=0 0',
		// 'a=group:BUNDLE 0',
		// 'a=extmap-allow-mixed',
		// 'a=msid-semantic: WMS',
		'm=application 9 UDP/DTLS/SCTP webrtc-datachannel',
		'c=IN IP4 0.0.0.0',
		...candidates.map(c => 'a=candidate:' + c),
		`a=ice-ufrag:${ice_ufrag}`,
		`a=ice-pwd:${ice_pwd}`,
		`a=fingerprint:sha-256 ${fingerprint}`,
		`a=setup:${type == 'offer' ? 'actpass' : 'passive'}`,
		// 'a=mid:0',
		'a=sctp-port:5000',
		// 'a=max-message-size:262144',
		'',
	].join('\n');
	return {sdp, type}
}
</script>
