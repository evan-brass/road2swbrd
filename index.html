<script type="module">
	const default_config = {
		iceServers: [
			{ urls: 'stun:global.stun.twilio.com' },
			{ urls: 'stun:stun.l.google.com:19302' }
		]
	};
	class Conn extends RTCPeerConnection {
		#dc = this.createDataChannel('_', { negotiated: true, id: 0 })
		constructor(config = null, remote_desc) {
			super({ ...default_config, ...config });
			this.#dc.addEventListener('open', () => console.log('Connected!'));

			this.#signaling_task(remote_desc);
		}
		#local_res;
		#local = new Promise(res => this.#local_res = res);
		get local() {
			return this.#local;
		}
		#remote_res;
		#remote = new Promise(res => this.#remote_res = res);
		set remote(description) {
			this.#remote_res(description);
		}
		async #signaling_task(remote_desc) {
			if (remote_desc) {
				await this.setRemoteDescription(this.#expand(remote_desc));
			}
			await this.setLocalDescription();
			while (this.iceGatheringState != 'complete') await new Promise(res => this.addEventListener('icegatheringstatechange', res, {once: true}));
			const local = this.#collapse(this.localDescription);
			this.#local_res(local);

			if (this.signalingState == 'have-local-offer') {
				remote_desc = await this.#remote;
				await this.setRemoteDescription(this.#expand(remote_desc));
			}
		}
		#collapse({type, sdp}) {
			const {1: ice_ufrag} = /^a=ice-ufrag:(.+)/im.exec(sdp);
			const {1: ice_pwd} = /^a=ice-pwd:(.+)/im.exec(sdp);
			const {1: fingerprint} = /^a=fingerprint:sha-256 (.+)/im.exec(sdp);
			const candidates = Array.from(sdp.matchAll(/^a=candidate:(.+)/igm), ({ 1: candidate}) => candidate);
			const id = btoa(String.fromCharCode(...fingerprint.split(':').map(s => parseInt(s, 16))));

			return {type, sdp, ice_ufrag, ice_pwd, id, candidates};
		}
		#expand({type, sdp}) {
			return {type, sdp}
		}
	}

	const a = new Conn();
	const siga = await a.local;
	console.log(siga);

	const b = new Conn(null, siga);
	const sigb = await b.local;
	console.log(sigb);
	a.remote = sigb;
</script>
